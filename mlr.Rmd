---
title: "MLR"
output: html_document
---

```{r setup}
library(data.table)
library(tseries)
library(forecast)
library(TSA)
```
```{r}
traffic_dt <- as.data.table(traffic_2)

traffic_dt[, week_num := as.integer(car::recode(weekday,
    "'Monday'='1';'Tuesday'='2';'Wednesday'='3';'Thursday'='4';
    'Friday'='5';'Saturday'='6';'Sunday'='7'"))]

traffic_dt <- traffic_dt[,c("date_time","traffic_volume","date","weekday","year","temp")]
```

```{r}
ggplot(data = traffic_dt, aes(x = date, y = traffic_volume)) +
  geom_line() + 
  theme(panel.border = element_blank(),
        panel.background = element_blank(),
        panel.grid.minor = element_line(colour = "grey90"),
        panel.grid.major = element_line(colour = "grey90"),
        panel.grid.major.x = element_line(colour = "grey90"),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 12, face = "bold"),
        strip.text = element_text(size = 9, face = "bold")) +
  labs(x = "Date", y = "Traffic Volume")
```
```{r data prep}
traffic_dt <- traffic_dt[, week_num := as.integer(as.factor(traffic_dt[, weekday]))]
```

```{r}
train_data <- traffic_dt[(traffic_dt$year > 2014 & traffic_dt$year < 2017)]

n_date <- unique(train_data[, date])
n_weekdays <- unique(train_data[, weekday])
period <- 24

data_r <- train_data[(date %in% n_date[20:385])]
```

```{r}
ggplot(data_r, aes(date_time, traffic_volume)) +
  geom_line() +
  theme(panel.border = element_blank(),
        panel.background = element_blank(),
        panel.grid.minor = element_line(colour = "grey90"),
        panel.grid.major = element_line(colour = "grey90"),
        panel.grid.major.x = element_line(colour = "grey90"),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 12, face = "bold")) +
  labs(x = "Date", y = "Traffic Volume")
```

```{r}
ggplot(data_r, aes(date_time, temp)) +
  geom_line() +
  theme(panel.border = element_blank(),
        panel.background = element_blank(),
        panel.grid.minor = element_line(colour = "grey90"),
        panel.grid.major = element_line(colour = "grey90"),
        panel.grid.major.x = element_line(colour = "grey90"),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 12, face = "bold")) +
  labs(x = "Date", y = "Temperature (C)")
```

```{r}
qplot(temp, traffic_volume, data=data_r) +
  ylab("Traffic Volume") + xlab("Temperature (C)")
```
```{r}
data_s <- train_data[(date %in% n_date[20:21])]

data_s_time <- data_s[,c("date_time","traffic_volume")] 
ts_1 <- ts(data_s_time)
gglagplot(ts_1)
```
```{r}
data_s <- train_data[(date %in% n_date[20:350])]

data_s_time <- data_s[,c("date_time","traffic_volume")] 
ts_1 <- ts(data_s_time)
ggAcf(ts_1)
```
```{r}
adf.test(data_s_time$traffic_volume)
```
```{r}
# p <- periodogram(data_s_time$traffic_volume)
# data.table(period=1/p$freq, spec=p$spec)[order(-spec)][1:2]
```

```{r}
ggplot(data_s_time, aes(x = date_time, y = traffic_volume)) +
  geom_line() +
  xlab("Day") + ylab("Traffic Volume") +
  ggtitle("Traffic Volume Hourly")
```
```{r}
# n_ts_1 <- naive(ts_1)
# 
# res <- residuals(n_ts_1)
# 
# autoplot(res) + 
#   xlab("Day") + ylab("") +
#   ggtitle("Residuals from naÃ¯ve method")
```

```{r}
library(zoo)
library(lattice)


z <- read.zoo(data_s_time,  header = TRUE, tz = "CST")
xyplot(z)

zAgg <- aggregate(z,  by = as.yearmon,  FUN = mean)


plot(zAgg, xaxt = "n")

tt <- time(zAgg)
m <- format(tt, "%m")
axis(side = 1, at = tt, labels = ifelse(m == "01", trunc(tt), m), cex.axis = .7)
```
```{r}
n_date <- unique(data_s[, date])
n_weekdays <- unique(data_s[, weekday])
period <- 24
```

```{r}
data_t <- train_data[(date %in% n_date[57:70])]

ggplot(data_t, aes(date_time, traffic_volume)) +
  geom_line() +
  theme(panel.border = element_blank(),
        panel.background = element_blank(),
        panel.grid.minor = element_line(colour = "grey90"),
        panel.grid.major = element_line(colour = "grey90"),
        panel.grid.major.x = element_line(colour = "grey90"),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 12, face = "bold")) +
  labs(x = "Date", y = "Traffic_Volume")
```
```{r}
N <- nrow(data_t)
window <- N / period # number of days in the train set
# 1, ..., period, 1, ..., period - and so on for the daily season 
# using feature "week_num" for the weekly season
matrix_train <- data.table(traffic_volume = data_t[, traffic_volume],
                           Daily = as.factor(rep(1:period, window)),
                           Weekly = as.factor(data_t[, week_num]))
```
```{r}
lm_m_1 <- lm(traffic_volume ~ 0 + ., data = matrix_train)

smmr_1 <- summary(lm_m_1)
paste("R-squared: ",
      round(smmr_1$r.squared, 3),
      ", p-value of F test: ",
      1-pf(smmr_1$fstatistic[1], smmr_1$fstatistic[2], smmr_1$fstatistic[3]))
```
```{r}
datas <- rbindlist(list(data_t[, .(traffic_volume, date_time)],
                        data.table(traffic_volume = lm_m_1$fitted.values, data_time = data_t[, date_time])))
datas[, type := rep(c("Real", "Fitted"), each = nrow(data_t))]
 
ggplot(data = datas, aes(date_time, traffic_volume, group = type, colour = type)) +
  geom_line(size = 0.8) +
  theme_bw() +
  labs(x = "Time", y = "Traffic Volume",
       title = "Fit from MLR")
```
```{r}
ggplot(data = data.table(Fitted_values = lm_m_1$fitted.values,
                         Residuals = lm_m_1$residuals),
       aes(Fitted_values, Residuals)) +
  geom_point(size = 1.7) +
  geom_smooth() +
  geom_hline(yintercept = 0, color = "red", size = 1) +
  labs(title = "Fitted values vs Residuals")
```
```{r}
z <- ts(z)

volume_fit <- tslm(z ~ temp, data = data_s)
fcast <- forecast(volume_fit)
autoplot(fcast) +
  ggtitle("Forecasts of beer production using regression") +
  xlab("Year") + ylab("megalitres")
```
```{r}
fit_1 <- tslm(z ~ temp, data = data_s)
h <- 4
fcast.ave <- forecast(fit_1,
  newdata = data.frame(temp = rep(mean(data_s[,"temp"]), h)))
fcast.up <- forecast(fit.cons,
  newdata = data.frame(Income = rep(5, h)))
autoplot(uschange[, "Consumption"]) +
  ylab("% change in US consumption") +
  autolayer(fcast.ave, series = "Average increase",
    PI = TRUE) +
  autolayer(fcast.up, series = "Extreme increase",
    PI = TRUE) +
  guides(colour = guide_legend(title = "Scenario"))
```


